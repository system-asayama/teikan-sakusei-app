<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ã‚¹ãƒ­ãƒƒãƒˆãƒã‚·ãƒ³ï¼ˆ5ã‚¹ãƒ”ãƒ³åˆè¨ˆï¼‰</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='slot.css') }}">
</head>
<body>
  <header class="bar">
    <h1>ğŸ° ã‚¹ãƒ­ãƒƒãƒˆãƒã‚·ãƒ³ï¼ˆ5ã‚¹ãƒ”ãƒ³åˆè¨ˆï¼‰</h1>
    <div class="spacer"></div>
  </header>

  <main class="wrap">
    <!-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div class="survey-complete-message" style="background:#10b981;color:white;padding:1rem;border-radius:8px;margin-bottom:1rem;">
      <p style="margin:0 0 0.75rem 0;font-size:1.1rem;text-align:center">âœ… {{ survey_complete_message }}</p>
      {% if prizes %}
      <div style="background:rgba(255,255,255,0.15);padding:0.75rem;border-radius:6px;">
        <h3 style="margin:0 0 0.5rem 0;font-size:1rem;font-weight:bold;text-align:center">ğŸ æ™¯å“ä¸€è¦§</h3>
        <div style="display:grid;gap:0.4rem;font-size:0.9rem;">
          {% for prize in prizes %}
          <div style="display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.1);padding:0.4rem 0.6rem;border-radius:4px;">
            <span style="font-weight:bold;">ğŸ† {{ prize.rank }}</span>
            <span style="flex:1;margin:0 0.5rem;text-align:left;">{{ prize.name }}</span>
            <span style="background:rgba(255,255,255,0.25);padding:0.2rem 0.5rem;border-radius:3px;font-weight:bold;">
              {% if prize.max_score %}
                {{ prize.min_score }}ç‚¹ï½{{ prize.max_score }}ç‚¹
              {% else %}
                {{ prize.min_score }}ç‚¹ï½
              {% endif %}
            </span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    <!-- ã‚¹ãƒ­ãƒƒãƒˆæœ¬ä½“ -->
    <section class="slot">
      <div class="window">
        <div class="reels" id="reels">
          <div class="reel" data-reel="0"><div class="strip"></div></div>
          <div class="reel" data-reel="1"><div class="strip"></div></div>
          <div class="reel" data-reel="2"><div class="strip"></div></div>
        </div>
      </div>

      <div class="controls" style="display:flex;align-items:center;gap:.75rem">
        <button id="btn-spin" class="primary big">5å›ã‚¹ãƒ”ãƒ³</button>
        <span class="muted" id="round-indicator"></span>
      </div>

      <!-- åˆè¨ˆã®ä¸‹ -->
      <div id="status" class="status"></div>

      <!-- ğŸ”¹ é…å½“è¡¨ -->
      <div class="payout-card" style="margin-top:.75rem">
        <h3 style="margin:.25rem 0 .5rem;">é…å½“è¡¨</h3>
        <table class="grid" id="payout-table">
          <thead>
            <tr>
              <th style="width:8rem">è¡¨ç¤º</th>
              <th style="width:7rem;text-align:right">é…å½“</th>
            </tr>
          </thead>
          <tbody id="payout-rows"></tbody>
        </table>
      </div>
    </section>

    <!-- å±¥æ­´ -->
    <section class="history">
      <h2>å±¥æ­´</h2>
      <ul id="history"></ul>
    </section>
  </main>

  <!-- è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <dialog id="dlg">
    <form method="dialog" class="panel" id="cfg-form">
      <h3>è¨­å®š</h3>
      <div style="display:flex; gap:1rem; flex-wrap:wrap; align-items:center">
        <label>5å›åˆè¨ˆã®æœŸå¾…å€¤
          <input id="expected-total-5" type="number" step="0.01" min="0" value="2500" style="width:10rem">
        </label>
        <div class="spacer"></div>
      </div>

      <table class="grid">
        <thead>
          <tr>
            <th>ID</th>
            <th>è¡¨ç¤º</th>
            <th>é…å½“</th>
            <th>è‡ªå‹•ç¢ºç‡(%)</th>
            <th>è‰²</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
        <tfoot>
          <tr>
            <td colspan="6" style="display:flex;align-items:center;gap:.75rem;">
              <button type="button" id="add" class="sub">ï¼‹è¡Œè¿½åŠ </button>
              <span class="muted">åˆè¨ˆç¢ºç‡: <strong id="prob-total">0</strong>%ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</span>
              <span id="prob-warn" class="muted" style="display:none;color:#ef4444">â€»100%ã«ãªã‚‹ã‚ˆã†èª¿æ•´ã—ã¦ãã ã•ã„</span>
            </td>
          </tr>
        </tfoot>
      </table>

      <!-- ğŸ”¹ nä»¥ä¸Š n'ä»¥ä¸‹ã®ç¢ºç‡è¨ˆç®—ãƒ„ãƒ¼ãƒ« -->
      <fieldset style="margin-top:1rem;border:1px solid #ddd;padding:.75rem;border-radius:.5rem;">
        <legend>ğŸ¯ ç¢ºç‡è¨ˆç®—ãƒ„ãƒ¼ãƒ«</legend>
        <label>nä»¥ä¸Šã®åˆè¨ˆé…å½“ï¼š
          <input id="threshold-min" type="number" value="200" style="width:8rem;">
        </label>
        <label>ã€œ n'ä»¥ä¸‹ï¼ˆç©ºæ¬„ã§ä¸Šé™ãªã—ï¼‰ï¼š
          <input id="threshold-max" type="number" placeholder="âˆ" style="width:8rem;">
        </label>
        <button type="button" id="btn-calc-prob" class="sub">ç¢ºç‡ã‚’è¨ˆç®—</button>
        <div id="prob-result" class="muted" style="margin-top:.5rem;"></div>
      </fieldset>

      <div class="panel-actions">
        <div class="spacer"></div>
        <button id="btn-cancel" type="button">é–‰ã˜ã‚‹</button>
        <button id="btn-save" class="primary" type="submit">ä¿å­˜</button>
      </div>
    </form>
  </dialog>

  <script>
  const dlg = document.getElementById("dlg");
  const btnOpen = document.getElementById("btn-open");
  const btnCancel = document.getElementById("btn-cancel");
  if (btnOpen) btnOpen.onclick = () => dlg.showModal();
  if (btnCancel) btnCancel.onclick = () => dlg.close();

  // ğŸ”¹ ã€Œnä»¥ä¸Š n'ä»¥ä¸‹ã€ã®ç¢ºç‡ã‚’è¨ˆç®—
  const btnCalcProb = document.getElementById("btn-calc-prob");
  if (btnCalcProb) btnCalcProb.onclick = async () => {
    const tmin = parseFloat(document.getElementById("threshold-min").value || "0");
    const tmaxInput = document.getElementById("threshold-max").value.trim();
    const tmax = tmaxInput === "" ? null : parseFloat(tmaxInput);

    const res = await fetch("/calc_prob", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({threshold_min: tmin, threshold_max: tmax, spins: 5})
    });

    const j = await res.json();
    const el = document.getElementById("prob-result");

    if (j.ok) {
      if (tmax === null)
        el.textContent = `5å›åˆè¨ˆãŒ ${tmin} ä»¥ä¸Šã«ãªã‚‹ç¢ºç‡ï¼š ${(j.prob_ge * 100).toFixed(2)} %`;
      else
        el.textContent = `5å›åˆè¨ˆãŒ ${tmin} ä»¥ä¸Š ${tmax} ä»¥ä¸‹ã«ãªã‚‹ç¢ºç‡ï¼š ${(j.prob_range * 100).toFixed(2)} %`;
    } else {
      el.textContent = `è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${j.error || "ä¸æ˜"}`;
    }
  };
  </script>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦store_slugã‚’è¨­å®š
    window.STORE_SLUG = "{{ store_slug or '' }}";
  </script>
  <script src="{{ url_for('static', filename='slot.js') }}?v={{ range(1, 1000000) | random }}"></script>
</body>
</html>
