{% extends "base.html" %}

{% block title %}é¡§å®¢è©³ç´° - {{ store_name }}{% endblock %}

{% block content %}
<div class="container">
  <div class="header">
    <h1>é¡§å®¢è©³ç´°</h1>
    <p class="store-name">{{ store_name }}</p>
  </div>
  
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  
  <!-- é¡§å®¢æƒ…å ± -->
  <div class="info-card">
    <h2>é¡§å®¢æƒ…å ±</h2>
    <div class="info-grid">
      <div class="info-item">
        <div class="info-label">é¡§å®¢å</div>
        <div class="info-value">{{ customer[1] }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">é›»è©±ç•ªå·</div>
        <div class="info-value">{{ customer[2] or '-' }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</div>
        <div class="info-value">{{ customer[3] or '-' }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">ç™»éŒ²æ—¥</div>
        <div class="info-value">{{ customer[4].strftime('%Y-%m-%d') if customer[4] else '-' }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</div>
        <div class="info-value">{{ customer[5].strftime('%Y-%m-%d') if customer[5] else '-' }}</div>
      </div>
    </div>
  </div>
  
  <!-- ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰æƒ…å ± -->
  {% if card %}
  <div class="card-info-card">
    <h2>ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰æƒ…å ±</h2>
    <div class="stamp-stats">
      <div class="stamp-stat">
        <div class="stamp-stat-value">{{ card[1] }}</div>
        <div class="stamp-stat-label">ç¾åœ¨ã®ã‚¹ã‚¿ãƒ³ãƒ—</div>
      </div>
      <div class="stamp-stat">
        <div class="stamp-stat-value">{{ card[2] }}</div>
        <div class="stamp-stat-label">ç´¯è¨ˆã‚¹ã‚¿ãƒ³ãƒ—</div>
      </div>
      <div class="stamp-stat">
        <div class="stamp-stat-value">{{ card[3] }}</div>
        <div class="stamp-stat-label">ç‰¹å…¸åˆ©ç”¨å›æ•°</div>
      </div>
    </div>
    
    <div class="stamp-actions">
      <button onclick="showAddStampModal()" class="btn btn-primary">
        <span class="btn-icon">â•</span>
        ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
      </button>
      <button onclick="showRemoveStampModal()" class="btn btn-danger">
        <span class="btn-icon">â–</span>
        ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤
      </button>
    </div>
  </div>
  {% endif %}
  
  <!-- ã‚¹ã‚¿ãƒ³ãƒ—å±¥æ­´ -->
  {% if history %}
  <div class="history-card">
    <h2>ã‚¹ã‚¿ãƒ³ãƒ—å±¥æ­´</h2>
    <div class="history-list">
      {% for h in history %}
        <div class="history-item">
          <div class="history-icon {% if h[1] == 'add' %}icon-add{% else %}icon-remove{% endif %}">
            {% if h[1] == 'add' %}+{% else %}-{% endif %}
          </div>
          <div class="history-content">
            <div class="history-action">
              {% if h[1] == 'add' %}
                ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ  (+{{ h[0] }}å€‹)
              {% elif h[1] == 'remove' %}
                ã‚¹ã‚¿ãƒ³ãƒ—å‰Šé™¤ ({{ h[0] }}å€‹)
              {% else %}
                ç‰¹å…¸åˆ©ç”¨ ({{ h[0] }}å€‹)
              {% endif %}
            </div>
            {% if h[2] %}
              <div class="history-note">{{ h[2] }}</div>
            {% endif %}
            <div class="history-meta">
              <span class="history-by">{{ h[3] }}</span>
              <span class="history-date">{{ h[4] }}</span>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  
  <!-- ç‰¹å…¸åˆ©ç”¨å±¥æ­´ -->
  {% if reward_history %}
  <div class="history-card">
    <h2>ç‰¹å…¸åˆ©ç”¨å±¥æ­´</h2>
    <div class="history-list">
      {% for r in reward_history %}
        <div class="history-item">
          <div class="history-icon icon-reward">ğŸ</div>
          <div class="history-content">
            <div class="history-action">{{ r[1] }}</div>
            <div class="history-note">{{ r[0] }}ã‚¹ã‚¿ãƒ³ãƒ—ä½¿ç”¨</div>
            <div class="history-meta">
              <span class="history-by">{{ r[2] }}</span>
              <span class="history-date">{{ r[3] }}</span>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  
  <div class="back-link">
    <a href="{{ url_for('stampcard_admin.customers', store_id=store_id) }}">&larr; é¡§å®¢ä¸€è¦§ã«æˆ»ã‚‹</a>
  </div>
</div>

<!-- ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="addStampModal" class="modal">
  <div class="modal-content">
    <h3>ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ </h3>
    <form method="POST" action="{{ url_for('stampcard_admin.add_stamp', store_id=store_id, customer_id=customer[0]) }}">
      <div class="form-group">
        <label for="stamps">è¿½åŠ ã™ã‚‹ã‚¹ã‚¿ãƒ³ãƒ—æ•°</label>
        <input type="number" id="stamps" name="stamps" value="1" min="1" max="10" required>
      </div>
      <div class="form-group">
        <label for="note">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" id="note" name="note" placeholder="ä¾‹: æ¥åº—ç‰¹å…¸">
      </div>
      <div class="modal-actions">
        <button type="submit" class="btn btn-primary">è¿½åŠ </button>
        <button type="button" onclick="closeModal('addStampModal')" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </form>
  </div>
</div>

<!-- ã‚¹ã‚¿ãƒ³ãƒ—å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="removeStampModal" class="modal">
  <div class="modal-content">
    <h3>ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤</h3>
    <form method="POST" action="{{ url_for('stampcard_admin.remove_stamp', store_id=store_id, customer_id=customer[0]) }}">
      <div class="form-group">
        <label for="stamps_remove">å‰Šé™¤ã™ã‚‹ã‚¹ã‚¿ãƒ³ãƒ—æ•°</label>
        <input type="number" id="stamps_remove" name="stamps" value="1" min="1" max="{{ card[1] if card else 0 }}" required>
        <small>ç¾åœ¨ã®ã‚¹ã‚¿ãƒ³ãƒ—æ•°: {{ card[1] if card else 0 }}å€‹</small>
      </div>
      <div class="form-group">
        <label for="note_remove">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" id="note_remove" name="note" placeholder="ä¾‹: èª¤ä»˜ä¸ã®ä¿®æ­£">
      </div>
      <div class="modal-actions">
        <button type="submit" class="btn btn-danger">å‰Šé™¤</button>
        <button type="button" onclick="closeModal('removeStampModal')" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </form>
  </div>
</div>

<script>
function showAddStampModal() {
  document.getElementById('addStampModal').style.display = 'flex';
}

function showRemoveStampModal() {
  document.getElementById('removeStampModal').style.display = 'flex';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
}
</script>

<style>
  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .header {
    text-align: center;
    margin-bottom: 32px;
  }
  
  h1 {
    color: #333;
    margin-bottom: 8px;
    font-size: 28px;
  }
  
  .store-name {
    color: #666;
    font-size: 18px;
  }
  
  .alert {
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 20px;
  }
  
  .alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .info-card,
  .card-info-card,
  .history-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 24px;
  }
  
  h2 {
    color: #333;
    margin-bottom: 20px;
    font-size: 20px;
  }
  
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }
  
  .info-item {
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  
  .info-label {
    color: #666;
    font-size: 13px;
    margin-bottom: 4px;
  }
  
  .info-value {
    color: #333;
    font-size: 16px;
    font-weight: 600;
  }
  
  .stamp-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .stamp-stat {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  
  .stamp-stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #4CAF50;
    margin-bottom: 8px;
  }
  
  .stamp-stat-label {
    color: #666;
    font-size: 14px;
  }
  
  .stamp-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  
  .btn {
    padding: 14px;
    border: none;
    border-radius: 6px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s ease;
  }
  
  .btn-icon {
    font-size: 18px;
  }
  
  .btn-primary {
    background: #4CAF50;
    color: white;
  }
  
  .btn-primary:hover {
    background: #45a049;
  }
  
  .btn-danger {
    background: #f44336;
    color: white;
  }
  
  .btn-danger:hover {
    background: #da190b;
  }
  
  .btn-secondary {
    background: #e0e0e0;
    color: #333;
  }
  
  .btn-secondary:hover {
    background: #d0d0d0;
  }
  
  .history-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .history-item {
    display: flex;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  
  .history-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 700;
    flex-shrink: 0;
  }
  
  .icon-add {
    background: #d4edda;
    color: #155724;
  }
  
  .icon-remove {
    background: #f8d7da;
    color: #721c24;
  }
  
  .icon-reward {
    font-size: 24px;
  }
  
  .history-content {
    flex: 1;
  }
  
  .history-action {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
  }
  
  .history-note {
    font-size: 14px;
    color: #666;
    margin-bottom: 4px;
  }
  
  .history-meta {
    font-size: 13px;
    color: #999;
  }
  
  .history-by {
    margin-right: 12px;
  }
  
  .back-link {
    text-align: center;
  }
  
  .back-link a {
    color: #2196F3;
    text-decoration: none;
    font-weight: 500;
  }
  
  .back-link a:hover {
    text-decoration: underline;
  }
  
  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    background: white;
    border-radius: 12px;
    padding: 32px;
    max-width: 500px;
    width: 90%;
  }
  
  .modal-content h3 {
    margin: 0 0 24px 0;
    color: #333;
    font-size: 20px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    color: #333;
    font-weight: 600;
  }
  
  .form-group input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 15px;
    box-sizing: border-box;
  }
  
  .form-group small {
    display: block;
    margin-top: 4px;
    color: #666;
    font-size: 13px;
  }
  
  .modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }
  
  .modal-actions .btn {
    flex: 1;
  }
  
  @media (max-width: 768px) {
    .container {
      padding: 16px;
    }
    
    .stamp-stats {
      grid-template-columns: 1fr;
    }
    
    .stamp-actions {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}
