{% extends "base_customer.html" %}

{% block title %}„Éû„Ç§„Éö„Éº„Ç∏ - {{ store_name }}{% endblock %}

{% block content %}
<div class="container">
  <div class="header">
    <h1>{{ store_name }}</h1>
    <p class="welcome">„Çà„ÅÜ„Åì„Åù„ÄÅ{{ customer_name }}„Åï„Çì</p>
    <a href="{{ url_for('stampcard.customer_logout', store_slug=request.view_args.store_slug) }}" class="logout-btn">„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
  </div>
  
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  
  <!-- „Çπ„Çø„É≥„Éó„Ç´„Éº„Éâ -->
  <div class="stamp-card">
    <h2>{{ card.card_title }}</h2>
    <div class="stamp-progress">
      <div class="progress-text">
        {% if card.use_multi_rewards and card.rewards_list %}
          <span class="current">{{ card.current_stamps }}</span> „Çπ„Çø„É≥„ÉóÁç≤Âæó
        {% else %}
          <span class="current">{{ card.current_stamps }}</span> / {{ card.required_stamps }} „Çπ„Çø„É≥„Éó
        {% endif %}
      </div>
      {% if not card.use_multi_rewards %}
      <div class="progress-bar">
        <div class="progress-fill" style="width: {{ (card.current_stamps / card.required_stamps * 100) | round | int }}%"></div>
      </div>
      {% endif %}
    </div>
    
    {% if card.use_multi_rewards and card.rewards_list %}
      <!-- Ë§áÊï∞ÁâπÂÖ∏„É¢„Éº„Éâ -->
      <div class="rewards-progress">
        {% for reward in card.rewards_list %}
        <div class="reward-milestone {% if reward.achieved %}achieved{% endif %} {% if reward.can_use %}available{% endif %}">
          <div class="milestone-header">
            <div class="milestone-stamps">
              <span class="stamps-number">{{ reward.required_stamps }}</span>
              <span class="stamps-label">„Çπ„Çø„É≥„Éó</span>
            </div>
            <div class="milestone-status">
              {% if reward.can_use %}
                <span class="status-badge available">Âà©Áî®ÂèØËÉΩ</span>
              {% elif reward.achieved %}
                <span class="status-badge used">Âà©Áî®Ê∏à„Åø</span>
              {% else %}
                <span class="status-badge locked">Êú™ÈÅîÊàê</span>
              {% endif %}
            </div>
          </div>
          <div class="milestone-description">
            {{ reward.description }}
            {% if reward.is_repeatable %}
              <span class="repeatable-badge">Áπ∞„ÇäËøî„ÅóÂèØ</span>
            {% endif %}
          </div>
          {% if reward.can_use %}
          <button onclick="useMultiReward({{ reward.id }})" class="btn-use-reward">
            ÁâπÂÖ∏„Çí‰ΩøÁî®„Åô„Çã
          </button>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    {% else %}
      <!-- „Ç∑„É≥„Éó„É´„É¢„Éº„ÉâÔºàÂæìÊù•„ÅÆË°®Á§∫Ôºâ -->
      <div class="stamps-grid">
        {% for i in range(card.required_stamps) %}
          <div class="stamp-cell {% if i < card.current_stamps %}filled{% endif %}">
            {% if i < card.current_stamps %}
              <span class="stamp-icon">‚úì</span>
            {% else %}
              <span class="stamp-number">{{ i + 1 }}</span>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      
      <div class="reward-info">
        <p class="reward-title">ÁâπÂÖ∏ÂÜÖÂÆπ</p>
        <p class="reward-description">{{ card.reward_description }}</p>
      </div>
    {% endif %}
    
    <div class="card-actions">
      <a href="{{ url_for('stampcard.scan_qr', store_slug=request.view_args.store_slug) }}" class="btn btn-primary">
        <span class="btn-icon">üì∑</span>
        QR„Ç≥„Éº„Éâ„Çí„Çπ„Ç≠„É£„É≥
      </a>
      
      {% if not card.use_multi_rewards %}
        {% if card.can_use_reward %}
          <button onclick="useReward()" class="btn btn-reward">
            <span class="btn-icon">üéÅ</span>
            ÁâπÂÖ∏„Çí‰ΩøÁî®„Åô„Çã
          </button>
        {% else %}
          <button class="btn btn-disabled" disabled>
            <span class="btn-icon">üéÅ</span>
            ÁâπÂÖ∏„Çí‰ΩøÁî®„Åô„ÇãÔºà„ÅÇ„Å®{{ card.required_stamps - card.current_stamps }}ÂÄãÔºâ
          </button>
        {% endif %}
      {% endif %}
    </div>
  </div>
  
  <!-- Áµ±Ë®àÊÉÖÂ†± -->
  <div class="stats-card">
    <h3>Áµ±Ë®àÊÉÖÂ†±</h3>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-value">{{ card.total_stamps }}</div>
        <div class="stat-label">Á¥ØË®à„Çπ„Çø„É≥„Éó</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ card.rewards_used }}</div>
        <div class="stat-label">ÁâπÂÖ∏Âà©Áî®ÂõûÊï∞</div>
      </div>
    </div>
  </div>
  
  <!-- „Çπ„Çø„É≥„ÉóÂ±•Ê≠¥ -->
  {% if history %}
  <div class="history-card">
    <h3>„Çπ„Çø„É≥„ÉóÂ±•Ê≠¥</h3>
    <div class="history-list">
      {% for h in history %}
        <div class="history-item">
          <div class="history-icon">
            {% if h[1] == 'add' %}
              <span class="icon-add">+</span>
            {% else %}
              <span class="icon-use">-</span>
            {% endif %}
          </div>
          <div class="history-content">
            <div class="history-action">
              {% if h[1] == 'add' %}
                „Çπ„Çø„É≥„ÉóÁç≤Âæó: +{{ h[0] }}ÂÄã
              {% else %}
                ÁâπÂÖ∏‰ΩøÁî®: -{{ h[0] }}ÂÄã
              {% endif %}
            </div>
            {% if h[2] %}
              <div class="history-note">{{ h[2] }}</div>
            {% endif %}
            <div class="history-date">{{ h[3].strftime('%YÂπ¥%mÊúà%dÊó• %H:%M') }}</div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
  }
  
  .container {
    max-width: 600px;
    margin: 0 auto;
  }
  
  .header {
    text-align: center;
    margin-bottom: 24px;
    position: relative;
  }
  
  h1 {
    color: white;
    font-size: 28px;
    margin-bottom: 8px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  .welcome {
    color: rgba(255,255,255,0.9);
    font-size: 16px;
  }
  
  .logout-btn {
    position: absolute;
    top: 0;
    right: 0;
    color: white;
    text-decoration: none;
    padding: 8px 16px;
    border: 1px solid rgba(255,255,255,0.5);
    border-radius: 20px;
    font-size: 14px;
    transition: all 0.2s;
  }
  
  .logout-btn:hover {
    background: rgba(255,255,255,0.2);
  }
  
  .alert {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 14px;
  }
  
  .alert-success {
    background: #d4edda;
    color: #155724;
  }
  
  .alert-error {
    background: #f8d7da;
    color: #721c24;
  }
  
  .alert-warning {
    background: #fff3cd;
    color: #856404;
  }
  
  .stamp-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-bottom: 20px;
  }
  
  h2 {
    color: #333;
    font-size: 22px;
    margin-bottom: 20px;
    text-align: center;
  }
  
  .stamp-progress {
    margin-bottom: 24px;
  }
  
  .progress-text {
    text-align: center;
    font-size: 18px;
    color: #666;
    margin-bottom: 12px;
  }
  
  .current {
    font-size: 32px;
    font-weight: bold;
    color: #667eea;
  }
  
  .progress-bar {
    height: 12px;
    background: #e0e0e0;
    border-radius: 6px;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.3s ease;
  }
  
  /* Ë§áÊï∞ÁâπÂÖ∏Ë°®Á§∫ */
  .rewards-progress {
    margin-bottom: 24px;
  }
  
  .reward-milestone {
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.3s;
  }
  
  .reward-milestone.achieved {
    border-color: #4CAF50;
    background: #f1f8f4;
  }
  
  .reward-milestone.available {
    border-color: #667eea;
    background: #f0f3ff;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }
  
  .milestone-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .milestone-stamps {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .stamps-number {
    font-size: 28px;
    font-weight: bold;
    color: #667eea;
  }
  
  .stamps-label {
    font-size: 12px;
    color: #666;
  }
  
  .milestone-status {
    flex: 1;
    text-align: right;
  }
  
  .status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .status-badge.available {
    background: #667eea;
    color: white;
  }
  
  .status-badge.used {
    background: #4CAF50;
    color: white;
  }
  
  .status-badge.locked {
    background: #e0e0e0;
    color: #999;
  }
  
  .milestone-description {
    color: #333;
    font-size: 15px;
    margin-bottom: 12px;
    line-height: 1.5;
  }
  
  .repeatable-badge {
    display: inline-block;
    background: #FFC107;
    color: white;
    padding: 2px 8px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 8px;
  }
  
  .btn-use-reward {
    width: 100%;
    padding: 10px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .btn-use-reward:hover {
    background: #5568d3;
  }
  
  /* „Ç∑„É≥„Éó„É´„É¢„Éº„ÉâË°®Á§∫ */
  .stamps-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }
  
  .stamp-cell {
    aspect-ratio: 1;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 0.3s;
  }
  
  .stamp-cell.filled {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #667eea;
    color: white;
  }
  
  .stamp-number {
    color: #ccc;
    font-size: 16px;
  }
  
  .reward-info {
    background: #f0f3ff;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
  }
  
  .reward-title {
    font-size: 14px;
    color: #667eea;
    font-weight: 600;
    margin-bottom: 8px;
  }
  
  .reward-description {
    color: #333;
    font-size: 16px;
    line-height: 1.5;
  }
  
  .card-actions {
    display: grid;
    gap: 12px;
  }
  
  .btn {
    padding: 16px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
  }
  
  .btn-primary {
    background: #4CAF50;
    color: white;
  }
  
  .btn-primary:hover {
    background: #45a049;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
  }
  
  .btn-reward {
    background: #FF9800;
    color: white;
  }
  
  .btn-reward:hover {
    background: #F57C00;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
  }
  
  .btn-disabled {
    background: #e0e0e0;
    color: #999;
    cursor: not-allowed;
  }
  
  .btn-icon {
    font-size: 20px;
  }
  
  .stats-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-bottom: 20px;
  }
  
  h3 {
    color: #333;
    font-size: 18px;
    margin-bottom: 16px;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  
  .stat-item {
    text-align: center;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 12px;
  }
  
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 8px;
  }
  
  .stat-label {
    font-size: 14px;
    color: #666;
  }
  
  .history-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .history-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .history-item {
    display: flex;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  
  .history-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    flex-shrink: 0;
  }
  
  .icon-add {
    background: #4CAF50;
    color: white;
  }
  
  .icon-use {
    background: #FF9800;
    color: white;
  }
  
  .history-content {
    flex: 1;
  }
  
  .history-action {
    font-size: 15px;
    color: #333;
    font-weight: 600;
    margin-bottom: 4px;
  }
  
  .history-note {
    font-size: 13px;
    color: #666;
    margin-bottom: 4px;
  }
  
  .history-date {
    font-size: 12px;
    color: #999;
  }
  
  @media (max-width: 768px) {
    body {
      padding: 12px;
    }
    
    .stamp-card {
      padding: 20px;
    }
    
    .stamps-grid {
      gap: 8px;
    }
    
    .logout-btn {
      position: static;
      display: inline-block;
      margin-top: 12px;
    }
  }
</style>

<script>
function useReward() {
  if (confirm('ÁâπÂÖ∏„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÅãÔºü\n‰ΩøÁî®„Åô„Çã„Å®ÁèæÂú®„ÅÆ„Çπ„Çø„É≥„Éó„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô„ÄÇ')) {
    fetch('{{ url_for("stampcard.use_reward", store_slug=request.view_args.store_slug) }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('ÁâπÂÖ∏„Çí‰ΩøÁî®„Åó„Åæ„Åó„ÅüÔºÅ');
        location.reload();
      } else {
        alert('„Ç®„É©„Éº: ' + data.message);
      }
    })
    .catch(error => {
      alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
      console.error(error);
    });
  }
}

function useMultiReward(rewardId) {
  if (confirm('„Åì„ÅÆÁâπÂÖ∏„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÅãÔºü')) {
    fetch('{{ url_for("stampcard.use_multi_reward", store_slug=request.view_args.store_slug) }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ reward_id: rewardId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('ÁâπÂÖ∏„Çí‰ΩøÁî®„Åó„Åæ„Åó„ÅüÔºÅ');
        location.reload();
      } else {
        alert('„Ç®„É©„Éº: ' + data.message);
      }
    })
    .catch(error => {
      alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
      console.error(error);
    });
  }
}
</script>
{% endblock %}
