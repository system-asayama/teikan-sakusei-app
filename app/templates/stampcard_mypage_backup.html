{% extends "base.html" %}

{% block title %}„Éû„Ç§„Éö„Éº„Ç∏ - {{ store_name }}{% endblock %}

{% block content %}
<div class="container">
  <div class="header">
    <h1>{{ store_name }}</h1>
    <p class="welcome">„Çà„ÅÜ„Åì„Åù„ÄÅ{{ customer_name }}„Åï„Çì</p>
    <a href="{{ url_for('stampcard.customer_logout', store_slug=request.view_args.store_slug) }}" class="logout-btn">„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
  </div>
  
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  
  <!-- „Çπ„Çø„É≥„Éó„Ç´„Éº„Éâ -->
  <div class="stamp-card">
    <h2>{{ card.card_title }}</h2>
    <div class="stamp-progress">
      <div class="progress-text">
        <span class="current">{{ card.current_stamps }}</span> / {{ card.required_stamps }} „Çπ„Çø„É≥„Éó
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: {{ (card.current_stamps / card.required_stamps * 100) | round | int }}%"></div>
      </div>
    </div>
    
    <div class="stamps-grid">
      {% for i in range(card.required_stamps) %}
        <div class="stamp-cell {% if i < card.current_stamps %}filled{% endif %}">
          {% if i < card.current_stamps %}
            <span class="stamp-icon">‚úì</span>
          {% else %}
            <span class="stamp-number">{{ i + 1 }}</span>
          {% endif %}
        </div>
      {% endfor %}
    </div>
    
    <div class="reward-info">
      <p class="reward-title">ÁâπÂÖ∏ÂÜÖÂÆπ</p>
      <p class="reward-description">{{ card.reward_description }}</p>
    </div>
    
    <div class="card-actions">
      <a href="{{ url_for('stampcard.scan_qr', store_slug=request.view_args.store_slug) }}" class="btn btn-primary">
        <span class="btn-icon">üì∑</span>
        QR„Ç≥„Éº„Éâ„Çí„Çπ„Ç≠„É£„É≥
      </a>
      
      {% if card.can_use_reward %}
        <button onclick="useReward()" class="btn btn-reward">
          <span class="btn-icon">üéÅ</span>
          ÁâπÂÖ∏„Çí‰ΩøÁî®„Åô„Çã
        </button>
      {% else %}
        <button class="btn btn-disabled" disabled>
          <span class="btn-icon">üéÅ</span>
          ÁâπÂÖ∏„Çí‰ΩøÁî®„Åô„ÇãÔºà„ÅÇ„Å®{{ card.required_stamps - card.current_stamps }}ÂÄãÔºâ
        </button>
      {% endif %}
    </div>
  </div>
  
  <!-- Áµ±Ë®àÊÉÖÂ†± -->
  <div class="stats-card">
    <h3>Áµ±Ë®àÊÉÖÂ†±</h3>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-value">{{ card.total_stamps }}</div>
        <div class="stat-label">Á¥ØË®à„Çπ„Çø„É≥„Éó</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ card.rewards_used }}</div>
        <div class="stat-label">ÁâπÂÖ∏Âà©Áî®ÂõûÊï∞</div>
      </div>
    </div>
  </div>
  
  <!-- „Çπ„Çø„É≥„ÉóÂ±•Ê≠¥ -->
  {% if history %}
  <div class="history-card">
    <h3>„Çπ„Çø„É≥„ÉóÂ±•Ê≠¥</h3>
    <div class="history-list">
      {% for h in history %}
        <div class="history-item">
          <div class="history-icon">
            {% if h[1] == 'add' %}
              <span class="icon-add">+</span>
            {% else %}
              <span class="icon-use">-</span>
            {% endif %}
          </div>
          <div class="history-content">
            <div class="history-action">
              {% if h[1] == 'add' %}
                „Çπ„Çø„É≥„ÉóÁç≤Âæó (+{{ h[0] }}ÂÄã)
              {% else %}
                ÁâπÂÖ∏Âà©Áî® ({{ h[0] }}ÂÄã)
              {% endif %}
            </div>
            {% if h[2] %}
              <div class="history-note">{{ h[2] }}</div>
            {% endif %}
            <div class="history-date">{{ h[3] }}</div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  
  <!-- ÁâπÂÖ∏Âà©Áî®Â±•Ê≠¥ -->
  {% if reward_history %}
  <div class="history-card">
    <h3>ÁâπÂÖ∏Âà©Áî®Â±•Ê≠¥</h3>
    <div class="history-list">
      {% for r in reward_history %}
        <div class="history-item">
          <div class="history-icon">
            <span class="icon-reward">üéÅ</span>
          </div>
          <div class="history-content">
            <div class="history-action">{{ r[1] }}</div>
            <div class="history-note">{{ r[0] }}„Çπ„Çø„É≥„Éó‰ΩøÁî®</div>
            <div class="history-date">{{ r[2] }}</div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<script>
function useReward() {
  if (!confirm('ÁâπÂÖ∏„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÅãÔºü\n„Çπ„Çø„É≥„Éó„ÅåÊ∂àË≤ª„Åï„Çå„Åæ„Åô„ÄÇ')) {
    return;
  }
  
  fetch('{{ url_for("stampcard.use_reward", store_slug=request.view_args.store_slug) }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert(data.message);
    }
  })
  .catch(error => {
    alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error);
  });
}
</script>

<style>
  .container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .header {
    text-align: center;
    margin-bottom: 24px;
    position: relative;
  }
  
  h1 {
    color: #333;
    margin-bottom: 8px;
    font-size: 24px;
  }
  
  .welcome {
    color: #666;
    font-size: 16px;
  }
  
  .logout-btn {
    position: absolute;
    top: 0;
    right: 0;
    color: #2196F3;
    text-decoration: none;
    font-size: 14px;
  }
  
  .alert {
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 16px;
  }
  
  .alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .alert-warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
  }
  
  .stamp-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  
  .stamp-card h2 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
    font-size: 20px;
  }
  
  .stamp-progress {
    margin-bottom: 20px;
  }
  
  .progress-text {
    text-align: center;
    margin-bottom: 8px;
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }
  
  .current {
    color: #4CAF50;
    font-size: 24px;
  }
  
  .progress-bar {
    height: 12px;
    background: #e0e0e0;
    border-radius: 6px;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.3s ease;
  }
  
  .stamps-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  
  .stamp-cell {
    aspect-ratio: 1;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 0.3s ease;
  }
  
  .stamp-cell.filled {
    background: #4CAF50;
    border-color: #4CAF50;
    color: white;
  }
  
  .stamp-icon {
    font-size: 24px;
  }
  
  .stamp-number {
    color: #999;
    font-size: 16px;
  }
  
  .reward-info {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
  }
  
  .reward-title {
    color: #666;
    font-size: 14px;
    margin-bottom: 4px;
  }
  
  .reward-description {
    color: #333;
    font-size: 18px;
    font-weight: 600;
  }
  
  .card-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  
  .btn {
    padding: 14px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s ease;
  }
  
  .btn-icon {
    font-size: 18px;
  }
  
  .btn-primary {
    background: #2196F3;
    color: white;
  }
  
  .btn-primary:hover {
    background: #0b7dda;
  }
  
  .btn-reward {
    background: #FF9800;
    color: white;
  }
  
  .btn-reward:hover {
    background: #F57C00;
  }
  
  .btn-disabled {
    background: #e0e0e0;
    color: #999;
    cursor: not-allowed;
  }
  
  .stats-card,
  .history-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  
  h3 {
    color: #333;
    margin-bottom: 16px;
    font-size: 18px;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  
  .stat-item {
    text-align: center;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  
  .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #4CAF50;
    margin-bottom: 4px;
  }
  
  .stat-label {
    font-size: 14px;
    color: #666;
  }
  
  .history-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .history-item {
    display: flex;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  
  .history-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }
  
  .icon-add {
    background: #d4edda;
    color: #155724;
    font-weight: 700;
  }
  
  .icon-use {
    background: #fff3cd;
    color: #856404;
    font-weight: 700;
  }
  
  .icon-reward {
    font-size: 24px;
  }
  
  .history-content {
    flex: 1;
  }
  
  .history-action {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
  }
  
  .history-note {
    font-size: 14px;
    color: #666;
    margin-bottom: 4px;
  }
  
  .history-date {
    font-size: 13px;
    color: #999;
  }
  
  @media (max-width: 768px) {
    .container {
      padding: 16px;
    }
    
    .stamps-grid {
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }
    
    .card-actions {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}
