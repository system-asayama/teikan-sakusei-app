<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä½œæˆãƒ»ç·¨é›† - ç®¡ç†ç”»é¢</title>
  <link rel="stylesheet" href="/static/slot.css">
  <style>
    body {
      background: #f3f4f6;
    }
    .admin-header {
      background: white;
      padding: 16px 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .admin-header h1 {
      font-size: 20px;
      margin: 0;
      color: #1f2937;
    }
    .admin-header .user-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .admin-header .user-name {
      font-size: 14px;
      color: #6b7280;
    }
    .btn-logout {
      padding: 8px 16px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .container {
      max-width: 1200px;
      margin: 32px auto;
      padding: 0 24px;
    }
    .section {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    .section h2 {
      font-size: 18px;
      margin: 0 0 20px 0;
      color: #1f2937;
    }
    .form-group {
      margin-bottom: 24px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }
    .form-group input[type="text"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    .question-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      background: #fafafa;
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .question-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .btn-move {
      padding: 4px 8px;
      background: #6b7280;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .btn-move:hover {
      background: #4b5563;
    }
    .btn-move:disabled {
      background: #d1d5db;
      cursor: not-allowed;
    }
    .question-number {
      font-weight: 700;
      color: #3b82f6;
      font-size: 16px;
    }
    .btn-remove {
      padding: 6px 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-primary {
      padding: 12px 24px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 12px;
    }
    .btn-secondary {
      padding: 12px 24px;
      background: #6b7280;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .btn-add {
      padding: 10px 20px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }
    .option-item {
      display: flex;
      gap: 12px;
      margin-bottom: 8px;
      align-items: center;
    }
    .option-item input {
      flex: 1;
    }
    .option-item button {
      padding: 6px 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    .help-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 6px;
    }
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }
  </style>
</head>
<body>
  <div class="admin-header">
    <h1>ğŸ“ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä½œæˆãƒ»ç·¨é›†</h1>
    <div class="user-info">
      <span class="user-name">{{ admin.name }} ({{ admin.store_code }})</span>
      <a href="{{ url_for('survey_admin.admin_logout') }}" class="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>
  </div>

  <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="post" id="surveyForm">
      <div class="section">
        <h2>åŸºæœ¬è¨­å®š</h2>
        
        <div class="form-group">
          <label for="survey_title">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«</label>
          <input 
            type="text" 
            id="survey_title" 
            name="survey_title" 
            value="{{ survey_config.title }}"
            placeholder="ä¾‹: ãŠåº—ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ"
            required
          >
        </div>

        <div class="form-group">
          <label for="survey_description">èª¬æ˜æ–‡</label>
          <textarea 
            id="survey_description" 
            name="survey_description"
            placeholder="ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
          >{{ survey_config.description }}</textarea>
          <div class="help-text">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã®ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </div>

      <div class="section">
        <h2>è³ªå•é …ç›®</h2>
        <div id="questionsContainer">
          {% for question in survey_config.questions %}
          <div class="question-card" data-question-index="{{ loop.index0 }}">
            <div class="question-header">
              <span class="question-number">è³ªå• {{ loop.index }}</span>
              <div class="question-controls">
                {% if loop.index0 != 0 %}
                <button type="button" class="btn-move" onclick="moveQuestionUp(this)" title="ä¸Šã¸ç§»å‹•">â–²</button>
                <button type="button" class="btn-move" onclick="moveQuestionDown(this)" title="ä¸‹ã¸ç§»å‹•">â–¼</button>
                <button type="button" class="btn-remove" onclick="removeQuestion(this)">å‰Šé™¤</button>
                {% else %}
                <span style="font-size: 12px; color: #6b7280;">ï¼ˆå›ºå®šè³ªå•ï¼‰</span>
                {% endif %}
              </div>
            </div>

            <div class="form-group">
              <label>è³ªå•æ–‡</label>
              <input 
                type="text" 
                name="questions[{{ loop.index0 }}][text]" 
                value="{{ question.text }}"
                placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                {% if loop.index0 == 0 %}readonly style="background-color: #f3f4f6; cursor: not-allowed;"{% endif %}
                required
              >
            </div>

            <div class="form-group">
              <label>è³ªå•ã‚¿ã‚¤ãƒ—</label>
              <select name="questions[{{ loop.index0 }}][type]" onchange="updateQuestionType(this)" {% if loop.index0 == 0 %}disabled style="background-color: #f3f4f6; cursor: not-allowed;"{% endif %}>
                <option value="rating" {% if question.type == 'rating' %}selected{% endif %}>æ˜Ÿè©•ä¾¡ï¼ˆ1-5ï¼‰</option>
                <option value="radio" {% if question.type == 'radio' %}selected{% endif %}>å˜ä¸€é¸æŠ</option>
                <option value="checkbox" {% if question.type == 'checkbox' %}selected{% endif %}>è¤‡æ•°é¸æŠ</option>
                <option value="text" {% if question.type == 'text' %}selected{% endif %}>è‡ªç”±è¨˜è¿°</option>
              </select>
              {% if loop.index0 == 0 %}
              <!-- disabledã®selectã¯é€ä¿¡ã•ã‚Œãªã„ã®ã§ã€hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§é€ä¿¡ -->
              <input type="hidden" name="questions[{{ loop.index0 }}][type]" value="{{ question.type }}">
              {% endif %}
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; {% if loop.index0 == 0 %}cursor: not-allowed;{% else %}cursor: pointer;{% endif %}">
                <input 
                  type="checkbox" 
                  name="questions[{{ loop.index0 }}][required]" 
                  value="true"
                  {% if question.required %}checked{% endif %}
                  {% if loop.index0 == 0 %}disabled{% endif %}
                  style="width: auto; margin: 0;"
                >
                <span>ã“ã®è³ªå•ã‚’å¿…é ˆã«ã™ã‚‹</span>
              </label>
              {% if loop.index0 == 0 and question.required %}
              <!-- disabledã®checkboxã¯é€ä¿¡ã•ã‚Œãªã„ã®ã§ã€hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§é€ä¿¡ -->
              <input type="hidden" name="questions[{{ loop.index0 }}][required]" value="true">
              {% endif %}
            </div>

            {% if question.type in ['radio', 'checkbox'] %}
            <div class="form-group options-group">
              <label>é¸æŠè‚¢</label>
              <div class="options-container">
                {% set question_index = loop.index0 %}
                {% for option in question.options %}
                <div class="option-item">
                  <input 
                    type="text" 
                    name="questions[{{ question_index }}][options][]" 
                    value="{{ option }}"
                    placeholder="é¸æŠè‚¢ã‚’å…¥åŠ›"
                    {% if question_index == 0 %}readonly style="background-color: #f3f4f6; cursor: not-allowed;"{% endif %}
                  >
                  {% if question_index != 0 %}
                  <button type="button" onclick="removeOption(this)">å‰Šé™¤</button>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
              {% if question_index != 0 %}
              <button type="button" class="btn-add" onclick="addOption(this)">+ é¸æŠè‚¢ã‚’è¿½åŠ </button>
              {% endif %}
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>

        <button type="button" class="btn-add" onclick="addQuestion()">+ è³ªå•ã‚’è¿½åŠ </button>
      </div>

      <div class="section">
        <button type="submit" class="btn-primary">ä¿å­˜</button>
        <a href="{{ url_for('survey_admin.admin_dashboard') }}" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
      </div>
    </form>
  </div>

  <script>
    let questionIndex = {{ survey_config.questions|length }};

    function addQuestion() {
      const container = document.getElementById('questionsContainer');
      const questionCard = document.createElement('div');
      questionCard.className = 'question-card';
      questionCard.setAttribute('data-question-index', questionIndex);
      
      questionCard.innerHTML = `
        <div class="question-header">
          <span class="question-number">è³ªå• ${questionIndex + 1}</span>
          <div class="question-controls">
            <button type="button" class="btn-move" onclick="moveQuestionUp(this)" title="ä¸Šã¸ç§»å‹•">â–²</button>
            <button type="button" class="btn-move" onclick="moveQuestionDown(this)" title="ä¸‹ã¸ç§»å‹•">â–¼</button>
            <button type="button" class="btn-remove" onclick="removeQuestion(this)">å‰Šé™¤</button>
          </div>
        </div>

        <div class="form-group">
          <label>è³ªå•æ–‡</label>
          <input 
            type="text" 
            name="questions[${questionIndex}][text]" 
            placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
            required
          >
        </div>

        <div class="form-group">
          <label>è³ªå•ã‚¿ã‚¤ãƒ—</label>
          <select name="questions[${questionIndex}][type]" onchange="updateQuestionType(this)">
            <option value="rating">æ˜Ÿè©•ä¾¡ï¼ˆ1-5ï¼‰</option>
            <option value="radio">å˜ä¸€é¸æŠ</option>
            <option value="checkbox">è¤‡æ•°é¸æŠ</option>
            <option value="text">è‡ªç”±è¨˜è¿°</option>
          </select>
        </div>

        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input 
              type="checkbox" 
              name="questions[${questionIndex}][required]" 
              value="true"
              style="width: auto; margin: 0;"
            >
            <span>ã“ã®è³ªå•ã‚’å¿…é ˆã«ã™ã‚‹</span>
          </label>
        </div>
      `;
      
      container.appendChild(questionCard);
      questionIndex++;
      updateQuestionNumbers();
    }

    function removeQuestion(button) {
      if (confirm('ã“ã®è³ªå•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        button.closest('.question-card').remove();
        updateQuestionNumbers();
      }
    }

    function updateQuestionNumbers() {
      const questions = document.querySelectorAll('.question-card');
      questions.forEach((card, index) => {
        card.querySelector('.question-number').textContent = `è³ªå• ${index + 1}`;
        card.setAttribute('data-question-index', index);
        
        // ä¸Šä¸‹ç§»å‹•ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åŒ–
        const upBtn = card.querySelector('.btn-move:first-of-type');
        const downBtn = card.querySelector('.btn-move:nth-of-type(2)');
        if (upBtn) upBtn.disabled = (index === 0);
        if (downBtn) downBtn.disabled = (index === questions.length - 1);
      });
    }
    
    function moveQuestionUp(button) {
      const card = button.closest('.question-card');
      const index = parseInt(card.getAttribute('data-question-index'));
      
      // è³ªå•1ï¼ˆindex=0ï¼‰ã¨ãã®ä¸Šã¸ã®ç§»å‹•ã‚’é˜²ã
      if (index <= 1) return;
      
      const prev = card.previousElementSibling;
      if (prev && prev.classList.contains('question-card')) {
        const prevIndex = parseInt(prev.getAttribute('data-question-index'));
        if (prevIndex === 0) return; // è³ªå•1ã‚’è¶Šãˆã¦ç§»å‹•ã•ã›ãªã„
        card.parentNode.insertBefore(card, prev);
        updateQuestionNumbers();
      }
    }
    
    function moveQuestionDown(button) {
      const card = button.closest('.question-card');
      const index = parseInt(card.getAttribute('data-question-index'));
      
      // è³ªå•1ï¼ˆindex=0ï¼‰ã®ç§»å‹•ã‚’é˜²ã
      if (index === 0) return;
      
      const next = card.nextElementSibling;
      if (next && next.classList.contains('question-card')) {
        card.parentNode.insertBefore(next, card);
        updateQuestionNumbers();
      }
    }

    function updateQuestionType(select) {
      const questionCard = select.closest('.question-card');
      const type = select.value;
      const existingOptionsGroup = questionCard.querySelector('.options-group');
      
      if (existingOptionsGroup) {
        existingOptionsGroup.remove();
      }

      if (type === 'radio' || type === 'checkbox') {
        const questionIndex = questionCard.getAttribute('data-question-index');
        const optionsGroup = document.createElement('div');
        optionsGroup.className = 'form-group options-group';
        optionsGroup.innerHTML = `
          <label>é¸æŠè‚¢</label>
          <div class="options-container">
            <div class="option-item">
              <input 
                type="text" 
                name="questions[${questionIndex}][options][]" 
                placeholder="é¸æŠè‚¢ã‚’å…¥åŠ›"
              >
              <button type="button" onclick="removeOption(this)">å‰Šé™¤</button>
            </div>
          </div>
          <button type="button" class="btn-add" onclick="addOption(this)">+ é¸æŠè‚¢ã‚’è¿½åŠ </button>
        `;
        select.closest('.form-group').after(optionsGroup);
      }
    }

    function addOption(button) {
      const container = button.previousElementSibling;
      const questionCard = button.closest('.question-card');
      const questionIndex = questionCard.getAttribute('data-question-index');
      
      const optionItem = document.createElement('div');
      optionItem.className = 'option-item';
      optionItem.innerHTML = `
        <input 
          type="text" 
          name="questions[${questionIndex}][options][]" 
          placeholder="é¸æŠè‚¢ã‚’å…¥åŠ›"
        >
        <button type="button" onclick="removeOption(this)">å‰Šé™¤</button>
      `;
      container.appendChild(optionItem);
    }

    function removeOption(button) {
      const container = button.closest('.options-container');
      if (container.children.length > 1) {
        button.closest('.option-item').remove();
      } else {
        alert('æœ€ä½1ã¤ã®é¸æŠè‚¢ãŒå¿…è¦ã§ã™');
      }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¸Šä¸‹ç§»å‹•ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    document.addEventListener('DOMContentLoaded', function() {
      updateQuestionNumbers();
      
      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã«è³ªå•ã®input nameã‚’æ›´æ–°
      document.getElementById('surveyForm').addEventListener('submit', function(e) {
        const questions = document.querySelectorAll('.question-card');
        questions.forEach((card, index) => {
          // è³ªå•æ–‡
          const textInput = card.querySelector('input[name^="questions["]');
          if (textInput) {
            textInput.name = `questions[${index}][text]`;
          }
          
          // è³ªå•ã‚¿ã‚¤ãƒ—
          const typeSelect = card.querySelector('select[name^="questions["]');
          if (typeSelect) {
            typeSelect.name = `questions[${index}][type]`;
          }
          
          // é¸æŠè‚¢
          const optionInputs = card.querySelectorAll('input[name^="questions["][name$="[options][]"]');
          optionInputs.forEach(input => {
            input.name = `questions[${index}][options][]`;
          });
        });
      });
    });
  </script>
</body>
</html>
